<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
		<title id="app-name">Exhibitor</title>

		<link rel="stylesheet" type="text/css" href="css/blitzer/jquery-ui-1.8.16.custom.css" />
        <link rel="stylesheet" type="text/css" href="dynatree/skin/ui.dynatree.css">

		<script type="text/javascript" src="js/jquery-1.7.1.min.js"></script>
		<script type="text/javascript" src="js/jquery.cookie.js"></script>
		<script type="text/javascript" src="js/jquery.keyfilter.js"></script>
		<script type="text/javascript" src="js/jquery-ui-1.8.16.custom.min.js"></script>
		<script type="text/javascript" src="js/jquery.tools.min.js"></script>
		<script type="text/javascript" src="js/json2.js"></script>
        <script type="text/javascript" src="dynatree/jquery.dynatree.min.js"></script>
		<script type="text/javascript">
            var BUILTIN_TAB_QTY = 3;
            var AUTO_REFRESH_PERIOD = 10000;
            var UPDATE_STATE_PERIOD = 10000;

            function messageDialog(title, message)
            {
                $('#message-dialog-text').html(message);
                $("#message-dialog").dialog("option", "title", title);
                $("#message-dialog").dialog("option", "buttons",
                    {
                        "OK": function() {
                            $(this).dialog("close");
                        }
                    }
                );
                $("#message-dialog").dialog("open");
            }

            function okCancelDialog(title, message, okFunction)
            {
                $('#message-dialog-text').html(message);
                $("#message-dialog").dialog("option", "title", title);
                $("#message-dialog").dialog("option", "buttons",
                    {
                        "Cancel": function() {
                            $(this).dialog("close");
                        },

                        "OK": function() {
                            $(this).dialog("close");
                            okFunction();
                        }
                    }
                );
                $("#message-dialog").dialog("open");
            }

            var systemState;
            var connectedToExhibitor = true;
            function updateState()
            {
                $.getJSON('state', function(data)
                {
                    systemState = data;
                    systemState.running = (data.running === "true");    // it comes down as a string

                    if ( !connectedToExhibitor )
                    {
                        connectedToExhibitor = true;
                        messageDialog("", "Connection with the " + $('#app-name').html() + " server re-established.");
                    }

                    if ( systemState.running )
                    {
                        $('#tabs-main-running').show();
                        $('#tabs-main-not-running').hide();
                    }
                    else
                    {
                        $('#tabs-main-running').hide();
                        $('#tabs-main-not-running').show();
                    }

                    $('#instance-restarts-enabled')[0].checked = systemState.restartsEnabled;
                    $('#instance-restarts-disabled')[0].checked = !systemState.restartsEnabled;
                    $('#instance-restarts-enabled').button("refresh");
                    $('#instance-restarts-disabled').button("refresh");

                    $('#version').html(systemState.version);
                    $('#not-connected-alert').hide();
                    $('#instance-hostname').html(systemState.config.thisHostname);
                    $('#instance-id').html((systemState.config.thisServerId > 0) ? systemState.config.thisServerId : "n/a");

                    updateConfig();
                }).error(function() {
                  if ( connectedToExhibitor )
                  {
                      $('#not-connected-alert').show();
                      connectedToExhibitor = false;
                      messageDialog("Error", "The browser lost connection with the " + $('#app-name').html() + " server.");
                  }
                });
            }
            updateState();

            function updateConfig()
            {
                var backupPathsTab = $.makeArray(systemState.config.backupPaths);
                var backupPaths = "";
                for ( var i = 0; i < backupPathsTab.length; ++i )
                {
                    backupPaths += '<li>' + backupPathsTab[i] + '</li>';
                }
                if ( backupPaths.length == 0 )
                {
                    backupPaths = "<i>none</i>";
                }

                var restorePathsTab = $.makeArray(systemState.config.availableRestores);
                var restorePaths = "";
                for ( i = 0; i < restorePathsTab.length; ++i )
                {
                    restorePaths += '<li>' + restorePathsTab[i].date + " - " + restorePathsTab[i].name + '</li>';
                }
                if ( restorePaths.length == 0 )
                {
                    restorePaths = "<i>none</i>";
                }

                var serversTab = $.makeArray(systemState.config.servers);
                var servers = "";
                for ( i = 0; i < serversTab.length; ++i )
                {
                    servers += '<li>hostname: <strong>' + serversTab[i].hostname + "</strong> - Server ID: <strong>" + serversTab[i].serverId + '</strong></li>';
                }
                if ( servers.length == 0 )
                {
                    servers = "<i>none</i>";
                }

                $('#config-section').show();
                $('#servers').html(servers);
                $('#backup-paths').html(backupPaths);
                $('#restore-paths').html(restorePaths);
            }

            function refreshCurrentTab()
            {
                var selected = $("#tabs").tabs("option", "selected");
                $("#tabs").tabs("load", selected);
            }

            function initExplorer()
            {
                $("#tree").dynatree({
                    onActivate: function(node)
                    {
                        $.ajax
                            (
                                {
                                    url: "node-data",
                                    data: {"key": node.data.key},
                                    cache: false,
                                    dataType: 'json',
                                    success: function(data)
                                    {
                                        $("#path").text(node.data.key);
                                        $("#stat").text(data.stat);
                                        $("#data-bytes").text(data.bytes);
                                        $("#data-str").text(data.str);
                                    }
                                }
                            );
                    },

                    selectMode: 1,

                    children:
                        [
                            {title: "/", isFolder: true, isLazy: true, key: "/", expand: false, noLink: true}
                        ],

                    onLazyRead: function(node)
                    {
                        node.appendAjax
                            (
                                {
                                    url: "node",
                                    data: {"key": node.data.key},
                                    cache: false
                                }
                            );
                    },

                    onClick: function(node, event)
                    {
                        if ( node.getEventTargetType(event) == "expander" )
                        {
                            node.reloadChildren(function(node, isOk){});
                        }
                        return true;
                    },

                    persist: false
                });
            }

            function makePathsPojo(paths)
            {
                var pathsTab = new Array();
                var splitPath = paths.split(/[,\s]/);
                for ( var i in splitPath )
                {
                    if ( splitPath[i].length > 0 )
                    {
                        var thisPath =
                        {
                            path:splitPath[i]
                        };
                        pathsTab.push(thisPath);
                    }
                }
                return {
                    pathPojo: pathsTab
                };
            }

            function submitBackupPaths(paths)
            {
                var pojo = makePathsPojo(paths);
                $.ajax({
                    type: 'POST',
                    url: "set/backup-paths",
                    data: JSON.stringify(pojo),
                    contentType: "application/json",
                    success: function()
                    {
                        updateState();
                    }
                });
            }

            function submitServers(paths)
            {
                var pojo = makePathsPojo(paths);
                $.ajax({
                    type: 'POST',
                    url: "set/servers",
                    data: JSON.stringify(pojo),
                    contentType: "application/json",
                    success: function()
                    {
                        updateState();
                    }
                });
            }

			$(function(){
                $.getJSON('tabs', function(data) {
                    for ( var i = 0; i < data.uiTabSpec.length; ++i )
                    {
                        $('#tabs-list').append('<li><a href="' + data.uiTabSpec[i].url  + '">' + data.uiTabSpec[i].name + '</a></li>');
                    }
                    $('#tabs').tabs({
                        panelTemplate: '<div class="text"></div>',

                        show: function(event, ui)
                        {
                            var selected = $("#tabs").tabs("option", "selected");
                            if ( selected < BUILTIN_TAB_QTY )
                            {
                                $("#refresh-state-container").hide();
                            }
                            else
                            {
                                $("#refresh-state-container").show();
                            }
                        },

                        create: function(event, ui)
                        {
                            initExplorer();
                        }
                    });
                });

                $("#stop-button").button( {
                    icons: {
                        primary: "ui-icon-alert"
                    }
                }).click(function() {
                    okCancelDialog("Restart ZooKeeper", "Are you sure you want to restart ZooKeeper?", function() {
                        $.get("stop");
                        messageDialog("Restart ZooKeeper", "Stop request sent. Check the log for details.");
                    });
                    return false;
                });

                $("#start-button").button().click(function() {
                    var selected = $("#tabs").tabs("option", "selected");
                    $("#tabs").tabs("load", selected);
                    return false;
                });

                $('#backup-button').button({
                    icons: {
                        primary: "ui-icon-disk"
                    }
                }).click(function() {
                   $.get("start-backup");
                   messageDialog("Backup", "Backup request sent. Check the Log for details.");
                   return false;
                });

                $('#restore-button').button({
                    icons: {
                        primary: "ui-icon-arrowreturnthick-1-s"
                    }
                }).click(function() {
                   return false;
                });

                $('#main-config-button').button({
                    icons: {
                        primary: "ui-icon-pencil"
                    }
                }).click(function() {
                   updateConfigDialogValues();
                   $("#config-servers-dialog").dialog("open");
                   return false;
                });

                $('#backup-config-button').button({
                    icons: {
                        primary: "ui-icon-pencil"
                    }
                }).click(function() {
                   updateConfigDialogValues();
                   $("#config-backup-paths-dialog").dialog("open");
                   return false;
                });

                $("#message-dialog").dialog({
                    modal: true,
                    autoOpen: false
                });

                $("#config-dialog").dialog({
                    minWidth: 500,
                    modal: true,
                    autoOpen: false
                });

                $("#config-servers-dialog").dialog({
                    minWidth: 500,
                    modal: true,
                    autoOpen: false,
                    title: "Change Servers",
                    buttons:
                    {
                        "Cancel": function() {
                            $(this).dialog("close");
                        },

                        "Submit...": function() {
                            okCancelDialog("Change Servers", "Are you sure? This will cause the instances to be reconfigured and restarted.", function(){
                                    submitServers($('#config-servers').val());
                                }
                            );
                            $(this).dialog("close");
                        }
                    }
                });

                $("#config-backup-paths-dialog").dialog({
                    minWidth: 500,
                    modal: true,
                    autoOpen: false,
                    title: "Change Backup Paths",
                    buttons:
                    {
                        "Cancel": function() {
                            $(this).dialog("close");
                        },

                        "Submit": function() {
                            submitBackupPaths($('#config-backup-paths').val());
                            $(this).dialog("close");
                        }
                    }
                });

                $("#instance-restarts").buttonset({
                    create: function(event, ui)
                    {
                        $("#instance-restarts-enabled").button().click(function() {
                            $.get("set/restarts/true");
                            return false;
                        });
                        $("#instance-restarts-disabled").button().click(function() {
                            $.get("set/restarts/false");
                            return false;
                        });
                    }
                });

                var refreshInterval = null;
                $('#refresh-state-container').buttonset();
                $("#refresh-state-auto").button().click(function() {
                    if ( !refreshInterval )
                    {
                        refreshInterval = window.setInterval("refreshCurrentTab()", AUTO_REFRESH_PERIOD);
                    }
                    $.cookie("refresh-state-auto", "1");
                    return false;
                });
                $("#refresh-state-manual").button().click(function() {
                    if ( refreshInterval )
                    {
                        window.clearInterval(refreshInterval);
                        refreshInterval = null;
                    }
                    $.cookie("refresh-state-auto", "0");
                    return false;
                });

                if ( $.cookie("refresh-state-auto") )
                {
                    refreshInterval = window.setInterval("refreshCurrentTab()", AUTO_REFRESH_PERIOD);
                }
                $('#refresh-state-auto')[0].checked = $.cookie("refresh-state-auto");
                $('#refresh-state-manual')[0].checked = !$.cookie("refresh-state-auto");
                $('#refresh-state-auto').button("refresh");
                $('#refresh-state-manual').button("refresh");

                $('#not-connected-message').html("Not connected to " + $('#app-name').html() + " server");
                $('#page-title').html($('#app-name').html() + " for ZooKeeper");

                $('#help-config-servers').tooltip();
                $('#help-config-backup-paths').tooltip();

                window.setInterval("updateState()", UPDATE_STATE_PERIOD);
                updateState();
			});
		</script>
		<style type="text/css">
			/*demo page css*/
			body
            {
                font-family: "Arial", "Helvetica", "Verdana", sans-serif;
                margin: 5px;
                padding: 5px;
                font-size: 14px;
                background-color: #777;
            }

            td
            {
                overflow: scroll;
                padding:  5px;
            }

            td, .info
            {
                font-size: 75%;
            }

            .info
            {
                padding: 5px;
            }

            .text
            {
                font-family: monospace;
                font-size: 80%;
                padding: 3px;
                width: 100%;
                height: 75%;
                overflow: scroll;
                white-space: pre;
                border: 1px solid black;
            }

            .tooltip
            {
                display: none;
                background-color: #f5f5b5;
                font-size: 90%;
                height: 75px;
                width: 200px;
                padding: 8px;
                z-index: 65535;
            }

            #config-dialog label
            {
                margin-bottom: 6px;
                font-size: 90%;
                font-weight: bold;
            }

            #config-dialog input
            {
                margin-bottom: 6px;
                font-size: 90%;
                font-family: monospace;
                font-weight: normal;
            }

            #not-connected-alert
            {
                width: 300px;
                position: absolute;
                top: 5px;
                left: 50%;
                margin-left: -150px;
            }

            #instance-info
            {
                width: 300px;
                position: absolute;
                top: 5px;
                left: 100%;
                margin-left: -400px;
                font-size: 75%;
            }

            #title
            {
                font-size: 200%;
                font-weight: bold;
                padding: 3px;
                text-shadow: 2px 2px #888;
                color: #C00;
            }

            #version
            {
                font-size: 50%;
                font-weight: normal;
                font-style: italic;
                position: relative;
                left: 100%;
                margin-left: -40px;
                top: -1.5em;
            }

            #tree
            {
                width: 100%;
                height: 60%;
                overflow: scroll;
                border: 1px solid gray;
            }

            #path, #stat, #data-bytes, #data-str
            {
                font-family: monospace;
                font-size: 125%;
            }

            #instance-restarts
            {
                margin-bottom: 5px;
            }

            #refresh-state-container
            {
                margin-top: 7px;
                margin-bottom: 5px;
                text-align: right;
            }

            #backup-paths, #restore-paths, #servers
            {
                margin-top: 3px;
                margin-bottom: 15px;
                border: 1px solid black;
                padding: 5px;
                width: 500px;
            }

            #backup-paths li, #restore-paths li
            {
                font-family: monospace;
                padding-top: 3px;
                padding-bottom: 3px;
            }
            
            #backup-config, #backup-paths
            {
                margin-bottom: 20px;
            }

            #backup-tab-buttons
            {
                margin-top: 30px;
            }

            #start-stop-button-container
            {
                margin-top: 20px;
                margin-bottom: 20px;
            }
		</style>
	</head>

	<body>
        <div id="tabs" class="ui-tabs">
            <div id="title">
                <div id="page-title"></div>
                <div id="version"></div>
            </div>

            <div class="ui-widget" id="not-connected-alert">
                <div class="ui-state-error ui-corner-all" style="padding: 0 .7em;">
                    <p><span class="ui-icon ui-icon-alert" style="float: left; margin-right: .3em;"></span>
                        <strong id="not-connected-message"></strong></p>
                </div>
            </div>

            <div class="ui-widget" id="instance-info">
                <div class="ui-state-highlight ui-corner-all" style="padding: 10px;">
                    This Instance: <span id="instance-hostname" style="font-weight: bold;"></span><br/>
                    This Server ID: <span id="instance-id" style="font-weight: bold;"></span><br/>
                </div>
            </div>

            <ul id="tabs-list">
                <li><a href="#tabs-main">Control Panel</a></li>
                <li><a href="#tabs-explorer">Explorer</a></li>
                <li><a href="#tabs-backups">Backups</a></li>
            </ul>


            <div id="tabs-main" class="ui-helper-hidden">
                <div id="instance-restarts">
                    <strong>Auto-restart instance: </strong>
                    <input type="radio" id="instance-restarts-enabled" name="instance-restarts" value="enabled"/><label for="instance-restarts-enabled">Enabled</label>
                    <input type="radio" id="instance-restarts-disabled" name="instance-restarts" value="disabled"/><label for="instance-restarts-disabled">Disabled</label>
                </div>

                <div class="ui-widget" id="start-stop-button-container">
                    <div id="tabs-main-running" class="ui-helper-hidden">
                        <span id="stop-button-container">
                            <button id="stop-button">Stop ZooKeeper...</button>
                        </span>
                        <span style="margin-left: 10px;">ZooKeeper appears to be running</span>
                    </div>
                    <div id="tabs-main-not-running" class="ui-helper-hidden">
                        <span id="start-button-container">
                            <button id="start-button">Start ZooKeeper</button>
                        </span>
                        <span style="margin-left: 10px;">ZooKeeper appears to be <strong>not</strong> running</span>
                    </div>
                </div>

                <div class="ui-helper-hidden ui-widget" id="config-section">
                    <strong>Servers:</strong>
                    <div id="servers"></div>
                    <div id="main-edit-config-button-container">
                        <button id="main-config-button">Change Servers...</button>
                    </div>
                </div>
            </div>

            <div id="tabs-explorer" class="ui-helper-hidden">
                <div id="tree"></div>

                <div class="info">
                    <table>
                        <tr valign="top">
                            <td nowrap><strong>Path</strong></td> <td><span id="path"></span></td>
                        </tr>
                        <tr valign="top">
                            <td nowrap><strong>Stat</strong></td> <td><span id="stat"></span></td>
                        </tr>
                        <tr valign="top">
                            <td nowrap><strong>Data Bytes</strong></td> <td><span id="data-bytes"></span></td>
                        </tr>
                        <tr valign="top">
                            <td nowrap><strong>Data as String</strong></td> <td><span id="data-str"></span></td>
                        </tr>
                    </table>
                </div>
            </div>

            <div id="tabs-backups" class="ui-helper-hidden">
                <div id="backup-config"></div>

                <strong>Backup Paths:</strong><br/>
                <div id="backup-paths"></div>

                <strong>Available Backups for Playback:</strong><br/>
                <div id="restore-paths"></div>

                <div id="backup-tab-buttons">
                    <span id="restore-button-container">
                        <button id="restore-button">Playback a Backup...</button>
                    </span>

                    <span id="backup-config-button-container">
                        <button id="backup-config-button">Change Backup Paths...</button>
                    </span>

                    <span id="backup-button-container">
                        <button id="backup-button">Backup Now</button>
                    </span>
                </div>
            </div>
        </div>

        <div id="refresh-state-container" class="ui-helper-hidden">
            <input type="radio" id="refresh-state-auto" name="refresh-state" value="auto"/><label for="refresh-state-auto">Auto Reload</label>
            <input type="radio" id="refresh-state-manual" name="refresh-state" value="manual"/><label for="refresh-state-manual">Manual Reload</label>
        </div>

        <div id="message-dialog" class="ui-helper-hidden">
            <p>
            <span class="ui-icon ui-icon-alert" style="float: left; margin:0 7px 50px 0;"></span>
            <span id="message-dialog-text"></span>
            </p>
        </div>

        <div id="config-servers-dialog" class="ui-helper-hidden">
            <form action="javascript:void" name="config-servers-form">
                <label for="config-servers"><strong>Servers:</strong></label><br/>
                <textarea rows="4" cols="60" id="config-servers" class="ui-widget-content ui-corner-all"></textarea>
                <span id="help-config-servers" class="ui-icon ui-icon-help" style="float: right" title="List of servers in the cluster in the form: id:host, id:host, ... IMPORTANT: Changing this list will cause ZK instance, starts/restarts, etc."></span><br/>
            </form>
        </div>

        <div id="config-backup-paths-dialog" class="ui-helper-hidden">
            <form action="javascript:void" name="config-backup-paths-form">
                <label for="config-backup-paths"><strong>Backup Paths:</strong></label><br/>
                <textarea rows="4" cols="60" id="config-backup-paths" class="ui-widget-content ui-corner-all"></textarea>
                <span id="help-config-backup-paths" class="ui-icon ui-icon-help" style="float: right" title="ZKPaths to backup when the backup task is run in the form: path, path, ... End a path with * for a recursive backup (e.g. /a/b/*)"></span><br/>
            </form>
        </div>

        <div id="config-dialog" class="ui-helper-hidden">
            <form action="javascript:void" name="config-form">
                <script type="text/javascript">
                    function updateConfigDialogValues()
                    {
                        var backupPathsTab = $.makeArray(systemState.config.backupPaths);
                        var backupPaths = "";
                        for ( var i = 0; i < backupPathsTab.length; ++i )
                        {
                            if ( backupPaths.length > 0 )
                            {
                                backupPaths += ", ";
                            }
                            backupPaths += backupPathsTab[i];
                        }

                        var serversTab = $.makeArray(systemState.config.servers);
                        var servers = "";
                        for ( i = 0; i < serversTab.length; ++i )
                        {
                            if ( servers.length > 0 )
                            {
                                servers += ", ";
                            }
                            servers += serversTab[i].serverId + ":" + serversTab[i].hostname;
                        }

                        $('#config-backup-paths').val(backupPaths);
                        $('#config-servers').val(servers);
                    }
                </script>
            </form>
        </div>
    </body>
</html>



