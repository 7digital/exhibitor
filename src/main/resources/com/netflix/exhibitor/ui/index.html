<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
		<title id="app-name">Exhibitor</title>

		<link rel="stylesheet" type="text/css" href="css/blitzer/jquery-ui-1.8.16.custom.css" />
        <link rel="stylesheet" type="text/css" href="dynatree/skin/ui.dynatree.css">

		<script type="text/javascript" src="js/jquery-1.7.1.min.js"></script>
		<script type="text/javascript" src="js/jquery.cookie.js"></script>
		<script type="text/javascript" src="js/jquery.keyfilter.js"></script>
		<script type="text/javascript" src="js/jquery-ui-1.8.16.custom.min.js"></script>
        <script type="text/javascript" src="dynatree/jquery.dynatree.min.js"></script>
		<script type="text/javascript">
            var BUILTIN_TAB_QTY = 3;
            var AUTO_REFRESH_PERIOD = 10000;
            var UPDATE_STATE_PERIOD = 10000;

            function messageDialog(title, message)
            {
                $('#message-dialog-text').html(message);
                $("#message-dialog").dialog("option", "title", title);
                $("#message-dialog").dialog("option", "buttons",
                    {
                        "OK": function() {
                            $(this).dialog("close");
                        }
                    }
                );
                $("#message-dialog").dialog("open");
            }

            function doConfigDialog()
            {
                updateConfigDialogValues();
                $("#config-dialog").dialog("option", "title", "Edit Configuration");
                $("#config-dialog").dialog("option", "buttons",
                    {
                        "Cancel": function() {
                            $(this).dialog("close");
                        },

                        "Submit...": function() {
                            $(this).dialog("close");
                        }
                    }
                );
                $("#config-dialog").dialog("open");
            }

            function okCancelDialog(title, message, okFunction)
            {
                $('#message-dialog-text').html(message);
                $("#message-dialog").dialog("option", "title", title);
                $("#message-dialog").dialog("option", "buttons",
                    {
                        "Cancel": function() {
                            $(this).dialog("close");
                        },

                        "OK": function() {
                            $(this).dialog("close");
                            okFunction();
                        }
                    }
                );
                $("#message-dialog").dialog("open");
            }

            var systemState;
            var connectedToExhibitor = true;
            function updateState()
            {
                $.getJSON('state', function(data)
                {
                    systemState = data;
                    systemState.running = (data.running === "true");    // it comes down as a string

                    if ( !connectedToExhibitor )
                    {
                        connectedToExhibitor = true;
                        messageDialog("", "Connection with the " + $('#app-name').html() + " server re-established.");
                    }

                    if ( systemState.running )
                    {
                        $('#tabs-main-running').show();
                        $('#tabs-main-not-running').hide();
                    }
                    else
                    {
                        $('#tabs-main-running').hide();
                        $('#tabs-main-not-running').show();
                    }

                    $('#instance-restarts-enabled')[0].checked = systemState.restartsEnabled;
                    $('#instance-restarts-disabled')[0].checked = !systemState.restartsEnabled;
                    $('#instance-restarts-enabled').button("refresh");
                    $('#instance-restarts-disabled').button("refresh");

                    $('#version').html(systemState.version);
                    $('#not-connected-alert').hide();

                    updateConfig();
                }).error(function() {
                  if ( connectedToExhibitor )
                  {
                      $('#not-connected-alert').show();
                      connectedToExhibitor = false;
                      messageDialog("Error", "The browser lost connection with the " + $('#app-name').html() + " server.");
                  }
                });
            }
            updateState();

            function getServers()
            {
                var serversTab = $.makeArray(systemState.config.servers);
                var servers = "";
                for ( var i = 0; i < serversTab.length; ++i )
                {
                    if ( i > 0 )
                    {
                        servers += ", ";
                    }
                    servers += serversTab[i].serverId + ":" + serversTab[i].hostname;
                }
                return servers;
            }

            function updateConfig()
            {
                var backupSource = "";
                backupSource += '<div class="config-container"><div class="config-label">Backup Period:</div><div class="config-value">' + systemState.config.backupPeriodMs + ' ms</div></div>';
                backupSource += '<div class="config-container"><div class="config-label">Cleanup Period:</div><div class="config-value">' + systemState.config.cleanupPeriodMs + ' ms</div></div>';

                var configSource = "";
                configSource += '<div class="config-container"><div class="config-label">This server ID:</div><div class="config-value">' + systemState.config.thisServerId + '</div></div>';
                configSource += '<div class="config-container"><div class="config-label">Servers:</div><div class="config-value">' + getServers() + '</div></div>';
                configSource += '<div class="config-container"><div class="config-label">Max Backups:</div><div class="config-value">' + systemState.config.maxBackups + '</div></div>';
                configSource += '<div class="config-container"><div class="config-label">ZK Alive Checks:</div><div class="config-value">' + systemState.config.checkSeconds + ' second(s)</div></div>';
                configSource += backupSource;

                var backupPathsTab = $.makeArray(systemState.config.backupPaths);
                var backupPaths = "";
                for ( i = 0; i < backupPathsTab.length; ++i )
                {
                    backupPaths += '<li>' + backupPathsTab[i] + '</li>';
                }
                if ( backupPaths.length == 0 )
                {
                    backupPaths = "<i>none</i>";
                }

                $('#config-section').show();
                $('#config').html(configSource);
                $('#backup-paths').html(backupPaths);
                $('#backup-config').html(backupSource);
            }

            function refreshCurrentTab()
            {
                var selected = $("#tabs").tabs("option", "selected");
                $("#tabs").tabs("load", selected);
            }

            function initExplorer()
            {
                $("#tree").dynatree({
                    onActivate: function(node)
                    {
                        $.ajax
                            (
                                {
                                    url: "node-data",
                                    data: {"key": node.data.key},
                                    cache: false,
                                    dataType: 'json',
                                    success: function(data)
                                    {
                                        $("#path").text(node.data.key);
                                        $("#stat").text(data.stat);
                                        $("#data-bytes").text(data.bytes);
                                        $("#data-str").text(data.str);
                                    }
                                }
                            );
                    },

                    selectMode: 1,

                    children:
                        [
                            {title: "/", isFolder: true, isLazy: true, key: "/", expand: false, noLink: true}
                        ],

                    onLazyRead: function(node)
                    {
                        node.appendAjax
                            (
                                {
                                    url: "node",
                                    data: {"key": node.data.key},
                                    cache: false
                                }
                            );
                    },

                    onClick: function(node, event)
                    {
                        if ( node.getEventTargetType(event) == "expander" )
                        {
                            node.reloadChildren(function(node, isOk){});
                        }
                        return true;
                    },

                    persist: false
                });
            }

			$(function(){
                $.getJSON('tabs', function(data) {
                    for ( var i = 0; i < data.uiTabSpec.length; ++i )
                    {
                        $('#tabs-list').append('<li><a href="' + data.uiTabSpec[i].url  + '">' + data.uiTabSpec[i].name + '</a></li>');
                    }
                    $('#tabs').tabs({
                        panelTemplate: '<div class="text"></div>',

                        show: function(event, ui)
                        {
                            var selected = $("#tabs").tabs("option", "selected");
                            if ( selected < BUILTIN_TAB_QTY )
                            {
                                $("#refresh-state-container").hide();
                            }
                            else
                            {
                                $("#refresh-state-container").show();
                            }
                        },

                        create: function(event, ui)
                        {
                            initExplorer();
                        }
                    });
                });

                $("#stop-button").button( {
                    icons: {
                        primary: "ui-icon-alert"
                    }
                }).click(function() {
                    okCancelDialog("Restart ZooKeeper", "Are you sure you want to restart ZooKeeper?", function() {
                        $.get("stop");
                        messageDialog("Restart ZooKeeper", "Stop request sent. Check the log for details.");
                    });
                    return false;
                });

                $("#start-button").button().click(function() {
                    var selected = $("#tabs").tabs("option", "selected");
                    $("#tabs").tabs("load", selected);
                    return false;
                });

                $('#backup-button').button({
                    icons: {
                        primary: "ui-icon-disk"
                    }
                }).click(function() {
                   return false;
                });

                $('#main-config-button').button({
                    icons: {
                        primary: "ui-icon-pencil"
                    }
                }).click(function() {
                   doConfigDialog();
                   return false;
                });

                $('#backup-config-button').button({
                    icons: {
                        primary: "ui-icon-pencil"
                    }
                }).click(function() {
                   doConfigDialog();
                   return false;
                });

                $("#message-dialog").dialog({
                    modal: true,
                    autoOpen: false
                });

                $("#config-dialog").dialog({
                    minWidth: 500,
                    modal: true,
                    autoOpen: false
                });

                $("#instance-restarts").buttonset({
                    create: function(event, ui)
                    {
                        $("#instance-restarts-enabled").button().click(function() {
                            $.get("set/restarts/true");
                            return false;
                        });
                        $("#instance-restarts-disabled").button().click(function() {
                            $.get("set/restarts/false");
                            return false;
                        });
                    }
                });

                var refreshInterval = null;
                $('#refresh-state-container').buttonset();
                $("#refresh-state-auto").button().click(function() {
                    if ( !refreshInterval )
                    {
                        refreshInterval = window.setInterval("refreshCurrentTab()", AUTO_REFRESH_PERIOD);
                    }
                    $.cookie("refresh-state-auto", "1");
                    return false;
                });
                $("#refresh-state-manual").button().click(function() {
                    if ( refreshInterval )
                    {
                        window.clearInterval(refreshInterval);
                        refreshInterval = null;
                    }
                    $.cookie("refresh-state-auto", "0");
                    return false;
                });

                if ( $.cookie("refresh-state-auto") )
                {
                    refreshInterval = window.setInterval("refreshCurrentTab()", AUTO_REFRESH_PERIOD);
                }
                $('#refresh-state-auto')[0].checked = $.cookie("refresh-state-auto");
                $('#refresh-state-manual')[0].checked = !$.cookie("refresh-state-auto");
                $('#refresh-state-auto').button("refresh");
                $('#refresh-state-manual').button("refresh");

                $('#not-connected-message').html("Not connected to " + $('#app-name').html() + " server");
                $('#page-title').html($('#app-name').html() + " for ZooKeeper");

                window.setInterval("updateState()", UPDATE_STATE_PERIOD);
                updateState();
			});
		</script>
		<style type="text/css">
			/*demo page css*/
			body
            {
                font-family: "Arial", "Helvetica", "Verdana", sans-serif;
                margin: 5px;
                padding: 5px;
                font-size: 14px;
                background-color: #777;
            }

            td
            {
                overflow: scroll;
                padding:  5px;
            }

            td, .info
            {
                font-size: 75%;
            }

            .info
            {
                padding: 5px;
            }

            .text
            {
                font-family: monospace;
                font-size: 80%;
                padding: 3px;
                width: 100%;
                height: 75%;
                overflow: scroll;
                white-space: pre;
                border: 1px solid black;
            }

            .config-label
            {
                color: #000;
                float: left;
                width: 150px;
            }

            .config-value
            {
                color: #000;
                width: 100%;
            }

            .config-container
            {
                margin-bottom: 6px;
            }

            #config-dialog label
            {
                margin-bottom: 6px;
                font-size: 90%;
                font-weight: bold;
            }

            #config-dialog input
            {
                margin-bottom: 6px;
                font-size: 90%;
                font-family: monospace;
                font-weight: normal;
            }

            #not-connected-alert
            {
                width: 300px;
                position: absolute;
                top: 5px;
                left: 50%;
                margin-left: -150px;
            }

            #title
            {
                font-size: 200%;
                font-weight: bold;
                padding: 3px;
                text-shadow: 2px 2px #888;
                color: #C00;
            }

            #version
            {
                font-size: 50%;
                font-weight: normal;
                font-style: italic;
                position: relative;
                left: 100%;
                margin-left: -40px;
                top: -1.5em;
            }

            #tree
            {
                width: 100%;
                height: 60%;
                overflow: scroll;
                border: 1px solid gray;
            }

            #path, #stat, #data-bytes, #data-str
            {
                font-family: monospace;
                font-size: 125%;
            }

            #instance-restarts
            {
                margin-bottom: 5px;
            }

            #refresh-state-container
            {
                margin-top: 7px;
                margin-bottom: 5px;
                text-align: right;
            }

            #config
            {
                padding: 10px;
            }

            #backup-paths
            {
                margin-top: 3px;
                margin-bottom: 15px;
                border: 1px solid black;
                padding: 5px;
            }

            #backup-paths li
            {
                font-family: monospace;
                padding-top: 3px;
                padding-bottom: 3px;
            }

            #backup-config
            {
                margin-bottom: 30px;
            }
		</style>
	</head>

	<body>
        <div id="tabs" class="ui-tabs">
            <div id="title">
                <div id="page-title"></div>
                <div id="version"></div>
            </div>

            <div class="ui-widget" id="not-connected-alert">
                <div class="ui-state-error ui-corner-all" style="padding: 0 .7em;">
                    <p><span class="ui-icon ui-icon-alert" style="float: left; margin-right: .3em;"></span>
                        <strong id="not-connected-message"></strong></p>
                </div>
            </div>

            <ul id="tabs-list">
                <li><a href="#tabs-main">Control Panel</a></li>
                <li><a href="#tabs-explorer">Explorer</a></li>
                <li><a href="#tabs-backups">Backups</a></li>
            </ul>


            <div id="tabs-main" class="ui-helper-hidden">
                <div id="instance-restarts">
                    <strong>Auto-restart instance: </strong>
                    <input type="radio" id="instance-restarts-enabled" name="instance-restarts" value="enabled"/><label for="instance-restarts-enabled">Enabled</label>
                    <input type="radio" id="instance-restarts-disabled" name="instance-restarts" value="disabled"/><label for="instance-restarts-disabled">Disabled</label>
                </div>

                <div class="ui-widget">
                    <div class="ui-state-highlight ui-corner-all" style="padding: 10px;">
                        <div id="tabs-main-running" class="ui-helper-hidden">
                            ZooKeeper appears to be running
                            <div id="stop-button-container">
                                <button id="stop-button">Stop ZooKeeper...</button>
                            </div>
                        </div>
                        <div id="tabs-main-not-running" class="ui-helper-hidden">
                            ZooKeeper appears to be <strong>not</strong> running
                            <div id="start-button-container">
                                <button id="start-button">Start ZooKeeper</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="ui-helper-hidden ui-widget" id="config-section">
                    <p><strong>Configuration:</strong></p>
                    <div id="config"></div>
                    <div id="main-edit-config-button-container">
                        <button id="main-config-button">Change Configuration...</button>
                    </div>
                </div>
            </div>

            <div id="tabs-explorer" class="ui-helper-hidden">
                <div id="tree"></div>

                <div class="info">
                    <table>
                        <tr valign="top">
                            <td nowrap><strong>Path</strong></td> <td><span id="path"></span></td>
                        </tr>
                        <tr valign="top">
                            <td nowrap><strong>Stat</strong></td> <td><span id="stat"></span></td>
                        </tr>
                        <tr valign="top">
                            <td nowrap><strong>Data Bytes</strong></td> <td><span id="data-bytes"></span></td>
                        </tr>
                        <tr valign="top">
                            <td nowrap><strong>Data as String</strong></td> <td><span id="data-str"></span></td>
                        </tr>
                    </table>
                </div>
            </div>

            <div id="tabs-backups" class="ui-helper-hidden">
                <strong>Backup Paths:</strong><br/>
                <div id="backup-paths"></div>
                <div id="backup-config"></div>

                <span id="backup-button-container">
                    <button id="backup-button">Backup Now...</button>
                </span>

                <span id="backup-config-button-container">
                    <button id="backup-config-button">Change Configuration...</button>
                </span>
            </div>
        </div>

        <div id="refresh-state-container" class="ui-helper-hidden">
            <input type="radio" id="refresh-state-auto" name="refresh-state" value="auto"/><label for="refresh-state-auto">Auto Reload</label>
            <input type="radio" id="refresh-state-manual" name="refresh-state" value="manual"/><label for="refresh-state-manual">Manual Reload</label>
        </div>

        <div id="message-dialog" class="ui-helper-hidden">
            <p>
            <span class="ui-icon ui-icon-alert" style="float: left; margin:0 7px 50px 0;"></span>
            <span id="message-dialog-text"></span>
            </p>
        </div>

        <div id="config-dialog" class="ui-helper-hidden">
            <form action="javascript:void" name="config-form">


                <label for="config-servers">Servers:</label><br/>
                <input type="text" id="config-servers" size="50" class="ui-widget-content ui-corner-all"/>

                <label for="config-backup-paths">Backup Paths:</label><br/>
                <input type="text" id="config-backup-paths" size="50" class="mask-pint ui-widget-content ui-corner-all"/>

                <label for="config-this-server-id">This Server ID:</label>
                <input type="text" id="config-this-server-id" size="10" class="mask-pint ui-widget-content ui-corner-all"/>

                <label for="config-max-backups">Max Backups:</label>
                <input type="text" id="config-max-backups" size="10" class="mask-pint ui-widget-content ui-corner-all"/>

                <label for="config-check-seconds">ZK Alive Check Period (ms):</label>
                <input type="text" id="config-check-seconds" size="10" class="mask-pint ui-widget-content ui-corner-all"/>

                <label for="config-backup-period">Backup Period (ms):</label>
                <input type="text" id="config-backup-period" size="10" class="mask-pint ui-widget-content ui-corner-all"/>

                <label for="config-cleanup-period">Cleanup Period (ms):</label>
                <input type="text" id="config-cleanup-period" size="10" class="mask-pint ui-widget-content ui-corner-all"/>

                <script type="text/javascript">
                    function updateConfigDialogValues()
                    {
                        var backupPathsTab = $.makeArray(systemState.config.backupPaths);
                        var backupPaths = "";
                        for ( var i = 0; i < backupPathsTab.length; ++i )
                        {
                            if ( backupPaths.length > 0 )
                            {
                                backupPaths += ", ";
                            }
                            backupPaths += backupPathsTab[0];
                        }

                        $('#config-servers').val(getServers());
                        $('#config-backup-paths').val(backupPaths);
                        $('#config-this-server-id').val(systemState.config.thisServerId);
                        $('#config-max-backups').val(systemState.config.maxBackups);
                        $('#config-check-seconds').val(systemState.config.checkSeconds);
                        $('#config-backup-period').val(systemState.config.backupPeriodMs);
                        $('#config-cleanup-period').val(systemState.config.cleanupPeriodMs);
                    }
                </script>
            </form>
        </div>
    </body>
</html>



